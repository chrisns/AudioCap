name: CI Pipeline

on:
  push:
    branches: [ "*" ]
  pull_request:
    branches: [ "*" ]

permissions:
  contents: write
  actions: read

jobs:
  test-and-build:
    runs-on: macos-15
    
    steps:
      - name: 📥 Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Needed for semantic versioning
      
      - name: 🔧 Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '15.4'
      
      - name: 🧪 Run Tests
        run: |
          xcodebuild test \
            -project AudioCap.xcodeproj \
            -scheme AudioCap \
            -destination 'platform=macOS' \
            -enableCodeCoverage YES
        env:
          AUDIOCAP_TEST_MODE: 1
          AUDIOCAP_MOCK_AUDIO: 1
      
      - name: 🏗️ Build Application
        run: |
          xcodebuild build \
            -project AudioCap.xcodeproj \
            -scheme AudioCap \
            -configuration Release \
            -destination 'platform=macOS'
      
      - name: � Cretate Distribution Archive
        run: |
          # Find the built app
          BUILD_DIR=$(xcodebuild -project AudioCap.xcodeproj -scheme AudioCap -configuration Release -showBuildSettings | grep "BUILT_PRODUCTS_DIR" | head -1 | sed 's/.*= //')
          APP_BUNDLE="$BUILD_DIR/AudioCap.app"
          
          # Get version from Info.plist
          VERSION=$(plutil -extract CFBundleShortVersionString raw "$APP_BUNDLE/Contents/Info.plist")
          
          # Create distribution
          mkdir -p dist
          cp -R "$APP_BUNDLE" dist/
          cd dist && zip -r "../AudioCap-${VERSION}.zip" AudioCap.app
          
          # Store for later steps
          echo "ARTIFACT_PATH=AudioCap-${VERSION}.zip" >> $GITHUB_ENV
          echo "APP_VERSION=${VERSION}" >> $GITHUB_ENV
      
      - name: 🚀 Create Release (Main Branch Only)
        if: github.ref == 'refs/heads/main'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ env.APP_VERSION }}
          name: AudioCap v${{ env.APP_VERSION }}
          body: |
            ## AudioCap Release ${{ env.APP_VERSION }}
            
            AudioCap is a macOS sample application demonstrating CoreAudio process tap functionality.
            
            ### Installation
            1. Download AudioCap.zip from the assets below
            2. Extract and move AudioCap.app to your Applications folder
            3. Grant audio recording permissions when prompted
            
            ### Requirements
            - macOS 14.4 or later
            - Audio recording permissions
            
            **Built with Xcode 15.4 • Universal Binary (Apple Silicon + Intel)**
          files: ${{ env.ARTIFACT_PATH }}
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}